# NKSS: PL/SQL Simple Scheduler
### Run concurrent programs with an arbitrary number of workers

Although tools like Apache JMeter is very good to simulate high concurrency,  
I always prefer run my tests and production batch parallel processing directly from the database.

This very simple API can be used for any type of processing and workloads within the database.

With more and more cores being added to processors nowadays, there's no excuse to write single  
core batch programs anymore.

The API consists in mere two database tables, four PL/SQL packages to orchestrate the things,  
and one very generic DBMS_SCHEDULER program.

Tables:  
NKSS_TASKSET - Task definition  
NKSS_TASKLIST - All tasks that you want to run concurrently with a variable number of workers

```sql
╭─┤⛁ oracle@katana│⌚ 07:38:43│☂ 977│⚓ /d01/github/nkss/src│
└──╼ sqlplus nkss/nkss

SQL*Plus: Release 11.2.0.2.0 Production on Sun Oct 8 07:38:50 2017
Copyright (c) 1982, 2011, Oracle.  All rights reserved.
Connected to:
Oracle Database 11g Express Edition Release 11.2.0.2.0 - 64bit Production

NKSS@XE:SQL> desc nkss_taskset
 Name                                      Null?    Type
 ----------------------------------------- -------- ----------------------------
 ID                                        NOT NULL NUMBER(16)
 CREATED                                   NOT NULL TIMESTAMP(6)
 LABEL                                     NOT NULL VARCHAR2(150)
 PAYLOAD                                            CLOB
 ERRORSTACK                                         VARCHAR2(4000)

NKSS@XE:SQL> desc nkss_tasklist
 Name                                      Null?    Type
 ----------------------------------------- -------- ----------------------------
 ID                                        NOT NULL NUMBER(16)
 PID                                       NOT NULL NUMBER(16)
 STATUS                                    NOT NULL NUMBER(1)
 PAYLOAD                                   NOT NULL CLOB
 STARTED                                            TIMESTAMP(6)
 FINISHED                                           TIMESTAMP(6)
 CPUTIME                                            NUMBER(16)
 ERRORSTACK                                         VARCHAR2(4000)

NKSS@XE:SQL>
Disconnected from Oracle Database 11g Express Edition Release 11.2.0.2.0 - 64bit Production
```
Packages:  
NKSS_MANAGER: This is the only package you use directly, to create and submit your tasks.  
NKSS_WORKER: Called from the background job to compete with siblings in executing tasks.  
NKSS_TASKSET_DML: Simple CRUD API for table NKSS_TASKSET(Generated by NKSG: PL/SQL Simple Generator)  
NKSS_TASKLIST_DML: Simple CRUD API for table NKSS_TASKLIST(Generated by NKSG: PL/SQL Simple Generator)  

DBMS_SCHEDULER program:  
```sql
declare
  lc__         constant varchar2(100) := 'Anonymous PL/SQL Block:';
  lc_program   constant varchar2(30) := 'NKSS#WORKER';
  nl           constant varchar2(3) := '
';
  already_exists        exception;
  pragma exception_init(already_exists, -27477);    -- ORA-27477: "string.string" already exists
begin
  dbms_output.enable(buffer_size => 1e6);
  --------------------
  << create_program >>
  --------------------
  begin
    dbms_scheduler.create_program(program_name        => lc_program,
                                  program_type        => 'STORED_PROCEDURE',
                                  program_action      => 'nkss_worker.main',
                                  number_of_arguments => 1,
                                  enabled             => false,
                                  comments            => 'NKSS Worker');
  exception
    when already_exists then
      dbms_output.put_line('Program: ' || lc_program || ' already exists. Exiting now...');
      return;
    when others then
      raise_application_error(-20888, '<< create_program >>:' || $$plsql_line || nl || dbms_utility.format_error_stack);
  end create_program;
  -----------------------------
  << define_program_argument >>
  -----------------------------
  begin
    dbms_scheduler.define_program_argument(program_name      => lc_program,
                                           argument_position => 1,
                                           argument_name     => 'fv_setid',
                                           argument_type     => 'integer',
                                           out_argument      => false);
  exception when others then
    raise_application_error(-20888, '<< define_program_argument >>:' || $$plsql_line || nl || dbms_utility.format_error_stack);
  end define_program_argument;
  --------------------
  << enable_program >>
  --------------------
  begin
    dbms_scheduler.enable(name => lc_program);
  exception when others then
    raise_application_error(-20888, '<< enable_program >>:' || $$plsql_line || nl || dbms_utility.format_error_stack);
  end enable_program;
exception when others then
  raise_application_error(-20777, lc__ || $$plsql_line || nl || dbms_utility.format_error_stack);
end main;
```
After installing you can run the tests to familiarize with the API.

Cheers
